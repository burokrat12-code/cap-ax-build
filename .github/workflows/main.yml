name: Build cAP ax Firmware
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: sudo apt update && sudo apt install -y build-essential libncurses5-dev libssl-dev zlib1g-dev gawk wget git gettext python3 rsync unzip

      - name: Download ImageBuilder
        run: |
          # Этот скрипт найдет правильный путь, даже если они опять сменят имя папки
          BASE_URL="https://downloads.openwrt.org/snapshots/targets/qualcommax"
          # Ищем папку, которая начинается на ipq60xx
          SUB_DIR=$(wget -qO- $BASE_URL/ | grep -oE 'ipq60xx[_0-9a-z]*' | head -n 1)
          # Формируем полную ссылку на ImageBuilder
          IB_FILE=$(wget -qO- $BASE_URL/$SUB_DIR/ | grep -oE 'openwrt-imagebuilder-qualcommax-[a-zA-Z0-9_.]+\.tar\.xz' | head -n 1)
          echo "Downloading from: $BASE_URL/$SUB_DIR/$IB_FILE"
          wget $BASE_URL/$SUB_DIR/$IB_FILE
          tar -xJf *.tar.xz
          mv openwrt-imagebuilder-* ib

      - name: Build Firmware
        run: |
          cd ib
          # Собираем образ именно под cAP ax
          make image PROFILE=mikrotik_cap-ax PACKAGES="luci luci-ssl luci-proto-modemmanager luci-app-modemmanager modemmanager kmod-usb-net-cdc-mbim kmod-usb-net-qmi-wwan kmod-usb-serial-quectel ath11k-firmware-ipq6018 kmod-usb-core kmod-usb3"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_cAP_ax
          path: ib/bin/targets/qualcommax/*/*
